<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My Profile â€¢ True Purity</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body class="bg-light py-5">
    <div class="container" style="max-width:720px">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>My Profile</h3>
            <span id="authArea"></span>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form id="pfForm" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Full name</label>
                        <input name="name" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input name="email" class="form-control" readonly>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" type="submit">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="mb-3">Change password</h5>
                <form id="pwForm" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">New password</label>
                        <input name="password" type="password" class="form-control" minlength="6" required>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-outline-primary" type="submit">Update password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        ( async function ()
        {
            await Auth.renderAuthArea();
            const u = Auth.getUser();
            if ( !u ) { location.href = 'login.html'; return; }

            const pf = document.getElementById( 'pfForm' );
            const pw = document.getElementById( 'pwForm' );

            // load fresh user from API (recommended)
            try
            {
                const r = await authFetch( Auth.API_BASE + '/api/me' );
                if ( r.ok )
                {
                    const me = await r.json();
                    pf.name.value = me.name || u.name || '';
                    pf.email.value = me.email || u.email || '';
                } else
                {
                    pf.name.value = u.name || '';
                    pf.email.value = u.email || '';
                }
            } catch
            {
                pf.name.value = u.name || '';
                pf.email.value = u.email || '';
            }

            pf.addEventListener( 'submit', async ( e ) =>
            {
                e.preventDefault();
                const res = await authFetch( Auth.API_BASE + '/api/me', {
                    method: 'PATCH',
                    body: JSON.stringify( { name: pf.name.value.trim() } )
                } );
                if ( !res.ok ) { alert( 'Update failed' ); return; }
                const updated = await res.json();
                Auth.setAuth( Auth.getToken(), updated );  // keep token, bump user cache
                alert( 'Profile updated' );
            } );

            pw.addEventListener( 'submit', async ( e ) =>
            {
                e.preventDefault();
                const res = await authFetch( Auth.API_BASE + '/api/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify( { password: pw.password.value } )
                } );
                if ( !res.ok ) { alert( 'Password update failed' ); return; }
                pw.reset();
                alert( 'Password updated' );
            } );
        } )();
    </script>
</body>

</html>